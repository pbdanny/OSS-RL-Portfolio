---
output: 
  html_document:
    keep_md: true
---

# OSS RL Aug-Sep 2017 analysis on D36

```{r adjust_directory_if_needed, include=FALSE}
# Initialise Project
# Uncomment lines below if rmd file is placed in a subdirectory
# library(knitr)
# opts_knit$set(root.dir = normalizePath('../')) 
```

```{r load_project, include=FALSE}
# 1. Set options in config/global.dcf
# 2. Load packages listed in config/global.dcf
# 3. Import functions and coe in lib directory
# 4. Load data in data directory
# 5. Run data manipulations in munge directory 

rm(list = ls()) # optionally refresh workspace
library(ProjectTemplate); load.project()
```             

## Key number summary
```{r table_summary_result, echo=FALSE}
rl_os %>%
    filter(appr, approve_amount, fdd) %>%
    group_by(month) %>%
    summarise(finalize = n(), appr = sum(appr), 
              loansize_amt = sum(approve_amount), fdd_amt = sum(fdd)) %>%
    gather(key = kpi, value = value, -month) %>%
    spread(key = month, value = value) %>%
    mutate(kpi = factor(kpi, levels = c('finalize', 'appr', 
                                        'loansize_amt', 'fdd_amt'))) %>%
    arrange(kpi) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

## Key Kpi by Month
### Approved Performance

% Approval rate, Avg Loansize, Avg FDD, % Early 60D
```{r key_kpi_summary, echo=FALSE}
rl_os %>%
    group_by(month) %>%
    summarise(per_appr = sum(appr)/n()*100, 
              avg_loansize = sum(approve_amount)/sum(appr),
              avg_fdd = sum(fdd)/sum(appr), 
              per_early60D = sum(vxandearly60)/sum(appr)*100) %>%
    gather(key = kpi, value = value, -month) %>%
    spread(key = month, value = value) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

### Finalized Performance
Number of Appr, Decline, Cancel
```{r appr_decline_cancel_table, echo=FALSE}
rl_os %>%
    group_by(month, result) %>%
    summarise(finl = n()) %>%
    spread(key = month, value = finl) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Percent of Appr, Decline, Cancel
```{r appr_decline_cancel_table, echo=FALSE}
# table of percent
rl_os %>%
    group_by(month, result) %>%
    summarise(finl = n()) %>%
    mutate(per_finl = prop.table(finl)*100) %>%
    select(month, result, per_finl) %>%
    spread(key = month, value = per_finl) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Top Decline Reason
```{r top_decline, echo=FALSE}
rl_os %>%
    filter(result == 'D') %>%
    group_by(month, result_description) %>%
    summarise(finl = n()) %>%
    spread(key = month, value = finl) %>%
    top_n(5) %>%
    left_join(reason_desc, by = c('result_description' = 'reason_code')) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Percent top Decline Reason
```{r top_decline, echo=FALSE}
rl_os %>%
    filter(result == 'D') %>%
    group_by(month, result_description) %>%
    summarise(finl = n()) %>%
    mutate(per_finl = prop.table(finl)*100) %>%
    select(month, result_description, per_finl) %>%
    spread(key = month, value = per_finl) %>%
    top_n(5) %>%
    left_join(reason_desc, by = c('result_description' = 'reason_code')) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Top Cancel Reason
```{r top_cancel, echo=FALSE}
rl_os %>%
    filter(result == 'C') %>%
    group_by(month, result_description) %>%
    summarise(finl = n()) %>%
    spread(key = month, value = finl) %>%
    top_n(5) %>%
    left_join(reason_desc, by = c('result_description' = 'reason_code')) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Percent top Cancel Reason
```{r top_decline, echo=FALSE}
rl_os %>%
    filter(result == 'C') %>%
    group_by(month, result_description) %>%
    summarise(finl = n()) %>%
    mutate(per_finl = prop.table(finl)*100) %>%
    select(month, result_description, per_finl) %>%
    spread(key = month, value = per_finl) %>%
    top_n(5) %>%
    left_join(reason_desc, by = c('result_description' = 'reason_code')) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Customer income range table
```{r cust_inc_table, echo=FALSE}
rl_os %>%
    filter(income_range %in% c('10,000-14,999', '15,000-19,999', 
                               '20,000-29,999', '30,000 up')) %>%
    group_by(month, income_range) %>%
    summarise(finl = n()) %>%
    spread(key = month, value = finl) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Customer income histogram, (interactive graph)
```{r cust_inc_histogram, echo=FALSE}
library(plotly)
rl_os %>%
    filter(monthly_salary > 1) %>%
    ggplot(aes(x = monthly_salary, fill = factor(month))) + 
    geom_histogram(position = 'identity', alpha = 0.5)

```

Customer income density, (interactive graph)
```{r cust_inc_density, echo=FALSE}
p <- rl_os %>%
    filter(monthly_salary > 1) %>%
    ggplot(aes(x = monthly_salary, color = factor(month))) + geom_density() +
    scale_x_log10(breaks = c(10000, 15000, 20000, 30000, 40000, 50000), 
                  labels = c('10k', '15k', '20k', '30k', '40k', '50k'),
                  limits = c(5000, 150000))
ggplotly(p)
```

Customer age range table
```{r cust_age_table, echo=FALSE}
rl_os %>%
    group_by(month, cus_age_range) %>%
    summarise(finl = n()) %>%
    spread(key = month, value = finl) %>%
    kable(format = 'html', digits = 2,
          format.args = list(decimal.mark = ".", big.mark = ",")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = FALSE, position = 'left')
```

Customer age density, (interactive graph)
```{r cust_age_density, echo=FALSE}
p <- rl_os %>%
    ggplot(aes(x = age, color = factor(month))) + geom_density()
ggplotly(p)
```

Customer region table

Customer region map, (interactive map)

# Explore
Plot age distribution D36 vs others D

```{r simpleplot, echo=FALSE}
rl_os %>%
        filter(result == 'D') %>%
        mutate(D_group = ifelse(result_description == 'D36', 'D36', 'Oth-D')) %>%
        ggplot(aes(x = age, color = D_group)) +
        geom_density() +
        ggtitle("D36 vs Other-D Age Distribution")
```
